---
title: "Laboratorio de Bioestatística"
author: "Group 3"
date: "28 de Dezembro de 2019"
output:
  html_document:
    highlight: tango
    theme: united
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
      smooth_scroll: no
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r dtStart, results= FALSE}
library(here)
library(data.table)
library(unglue)
library(ggplot2)
library(magrittr)

data <- fread(here("CancerMortalityEU.csv"), 
              header = TRUE, check.names = TRUE)
popdt <- fread("PopulationEU.csv",
               header = TRUE, check.names=TRUE)
```

# Data Tidying 

## Cancer data

```{r cancerData, results= FALSE}
# Colunas certas nos dados
names(data)

cancro <- data[CancerSite %in% "Liver and Intrahepatic Bile Ducts"]


str(cancro)
cancro[, .N, by="CancerSite"] #Pode-se tirar esta coluna
cancro[, .N, by="Cause"] #Pode-se tirar esta coluna mas a ver se não se perde a informação
cancro[, .N, by="ageStart"] #Acho que se pode tirar também
cancro[, .N, by="ageLabel"] #Também acho que se pode tirar se bem que esta pode ser util à frente
cancro[, c("CancerSite", "Cause", "ageStart", "ageLabel"):=NULL]
setnames(cancro, "ageGroup", "Age")


# melt dos dados do cancro

cancer.new <- melt(cancro,
                   id.vars = c("Country","Age"),
                   variable.name = "all",
                   value.name = "Deaths")

cancer.new[, `:=` (Year=as.numeric(gsub("[^[:digit:].]",
                            "", all)))]

cancer.new[, Sex:=as.character(unglue_vec(all,"{x}_{y}",var="x"))]

cancer.new[, .N, by="Year"]
cancer.new[, .N, by="Sex"]
cancer.new[, all:=NULL]
setcolorder(cancer.new, c("Country","Age","Sex","Year","Deaths"))

# remoção de linhas com valores NA para cálculo correto do índice mortalidade
#cancer.new <- na.omit(cancer.new)

# Criação do EU

cancer.EU <- cancer.new[, .(Country = "European Union", Deaths = sum(Deaths, na.rm = TRUE)), by = .(Year, Sex, Age)]
setcolorder(cancer.EU, c("Country","Age","Sex","Year","Deaths"))
cancer.liver <- rbind(cancer.new,cancer.EU)

# Criação do all

allAge <- cancer.liver[, .(Age = "All", Deaths = sum(Deaths, na.rm = TRUE)), by = .(Country, Year, Sex)]
setcolorder(allAge, c("Country", "Sex", "Age", "Year", "Deaths"))
cancer.liver <- rbind(cancer.liver,allAge)

# Selecting the important countries

cancer.liver <- cancer.liver[Country %in% c("Austria", "Cyprus", "Germany", "Malta", "Portugal", "European Union")
                             ][order(Year, Country)]
```


## Population Data

```{r dtPop, results= FALSE}
# Importing data
library(data.table)
popdt <- fread("PopulationEU.csv",
               header = TRUE, check.names=TRUE)

# Removing ageStart and ageLabel columns
popdt[, c("ageStart","ageLabel","X2000","X2001","X2002","X2003","X2004","X2005","X2006","X2007","X2008","X2009","X2010"):=NULL]

# Renaming ageGroup column to Age
setnames(popdt, c("ageGroup"),
                c("Age"))

# Morphing to long format
popT <- melt(popdt,
            id.vars = c("Country", "Sex", "Age"),
            measure = patterns("^X"),
            variable.name = "YearX",
            value.name = c("Population"),
            na.rm = TRUE)

# Year as numeric, removing YearX
popT[, `:=` (Year=as.numeric(gsub("[^[:digit:].]",
                            "", YearX)))][, YearX := NULL]
setcolorder(popT, c("Country", "Sex", "Age", "Year", "Population"))

# Removing rows for total population data 

#Seeing as we are treating females and males differently, the rows regarding total population info will not be used and should be removed.
popT <- popT[Sex != "Total"]

# Creating European Union as "Country"
#EU's population is the sum of the populations for each country, by year and age group

popEU <- popT[, .(Population = sum(Population, na.rm = TRUE)), by = .(Year, Sex, Age)][, Country := "European Union"]
setcolorder(popEU, c("Country", "Sex", "Age", "Year", "Population"))
pop <- rbind(popT, popEU)
pop <- pop[order(Year, Country)]

# Creating age group category "All", combining all ages
allAge <- pop[, .(Age = "All", Population = sum(Population, na.rm = TRUE)), by = .(Country, Year, Sex)]
setcolorder(allAge, c("Country", "Sex", "Age", "Year", "Population"))
allAge <- allAge[order(Year, Country)]

# Merging pop and allAge
pop <- rbind(pop, allAge)
pop <- pop[order(Year, Country, Sex)]

# Selecting only the countries in study
popF <- pop[Country %in% c("Austria", "Cyprus", "Germany", "Malta", "Portugal", "European Union")]
popF <- popF[order(Year, Country)]

popF
```

## Merging of the two data sets

```{r final data set}
data.f <- cancer.liver[popF, on=c("Country","Age","Sex","Year")]
data.f[, mrate := round(100000*Deaths/Population,2)]
data.f[Age %in% "All"][Sex %in% "Females"][, sum(Deaths, na.rm = TRUE), by=Country]
data.f <- na.omit(data.f)
data.f
```


# End of the Great Tyiding

# First Question 

What are the time trends in the mortality rates between countries for all age groups (“All”) combined ?
– How do they compare with the European Union overall?

```{r Time trends for females}
data.f[Age %in% "All"][Sex %in% "Females"] %>% 
ggplot(aes(Year,mrate, group=Country, colour = Country))+
    geom_point(size=2)+
    geom_line()+
    ggtitle("Time trends of Liver Cancer on the Female population")+
    ylab("Mortality Rate")
    
```
  
  * Looking at the data for hepatic cancer mortality rate for females we can note an overall increasing trend for every country, as well as for the European Union.
  * Malta, Austria and Cyprus display the most irregular trends, probably explained by the lack of values for some of the ages, in these countries.
   + Austria - with increases and decreases over the years, the mortality rate has been relatively stable, comparing 2011 data to 2017.
    + Malta - an increase from 2011 (below 3) to 2017 (3,5), with a max in the year 2014. However, it remains one of the countries with the lowest mortality rate.
   + Cyprus - overall increase, with mortality peaks in 2013 and 2016.
  * For Portugal and Malta there is no data for the year 2017, which might help explain the steep decrease in mortality rate for the European Union, as there might be more countries without data for that year.
  * Portugal, Germany and EU show an overall increase, with Portugal's mortality rate increasing the most among them (5.2 to 6).
  * These five countries show lower mortality rates than the European Union for every year, except for Austria in 2012 (not taking 2017 into account).

```{r Time trends for males}
data.f[Age %in% "All"][Sex %in% "Males"] %>% 
ggplot(aes(Year,mrate, group=Country, colour = Country))+
    geom_point(size=2)+
    geom_line()+
    ggtitle("Time trends of Liver Cancer on the Male population")+
    ylab("Mortality Rate")
```

  * For males, like females, there is an increase in hepatic liver mortality rate over the years.
    + An exception is Germany, showing stable values for the years 2011 and 2017.
  * Malta displays the steepest increase in 2016 (from 7 to 13.8).
  *  Portugal displays the highest values (close to 17.5) while Cyprus has the lowest (even though the increase in mortality rate over the years is on par with Portugal).
  * The overall values for mortality are higher than those of females.
  * Portugal and Austria display higher values than the European Union, while the remaining countries stay below the average (aside from 2017).


# Second question

Compare the mortality rates by age groups between countries for 2017.

```{r ageMR}
data.f[Sex %in% "Females"] %>%
ggplot(aes(Year,mrate, group=Country))+
    geom_line()+
    facet_wrap(~Age)
```

# Third Question

Which country changed (increase or decreased) the most in percentage terms between 2011 and 2017?
  – Plot and tabulate the percentage change overtime by country.
  
  
  

# Fourth Question - Most common cancers

What are the five (5) most common cancers in 2011? in 2017 for your countries?










