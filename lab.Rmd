---
title: "Laboratorio de Bioestatística"
author: "Group 3"
date: "28 de Dezembro de 2019"
output:
  html_document:
    highlight: tango
    theme: united
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
      smooth_scroll: no
  pdf_document:
    toc: yes
    toc_depth: '3'
---

# Tidying Cancer Data 

```{r cancerData, results= FALSE}
library(here)
library(data.table)
library(unglue)

data <- fread(here("CancerMortalityEU.csv"), header = TRUE, check.names = TRUE)

# Colunas certas nos dados
names(data)

cancro <- data[CancerSite %in% "Liver and Intrahepatic Bile Ducts"]


str(cancro)
cancro[, .N, by="CancerSite"] #Pode-se tirar esta coluna
cancro[, .N, by="Cause"] #Pode-se tirar esta coluna mas a ver se não se perde a informação
cancro[, .N, by="ageStart"] #Acho que se pode tirar também
cancro[, .N, by="ageLabel"] #Também acho que se pode tirar se bem que esta pode ser util à frente
cancro[, c("CancerSite", "Cause", "ageStart", "ageLabel"):=NULL]
setnames(cancro, "ageGroup", "Age")


# melt dos dados do cancro

cancer.new <- melt(cancro,
                   id.vars = c("Country","Age"),
                   variable.name = "all",
                   value.name = "Frequencie")

cancer.new[, `:=` (Year=as.numeric(gsub("[^[:digit:].]",
                            "", all)))]

cancer.new[, Sex:=as.character(unglue_vec(all,"{x}_{y}",var="x"))]

cancer.new[, .N, by="Year"]
cancer.new[, .N, by="Sex"]
cancer.new[, all:=NULL]
setcolorder(cancer.new, c("Country","Age","Sex","Year","Frequencie"))

# Criação do EU

cancer.EU <- cancer.new[, .(Country = "European Union", Frequencie = sum(Frequencie, na.rm = TRUE)), by = .(Year, Sex, Age)]
setcolorder(cancer.EU, c("Country","Age","Sex","Year","Frequencie"))
cancer.liver <- rbind(cancer.new,cancer.EU)

# Criação do all

allAge <- cancer.liver[, .(Age = "All", Frequencie = sum(Frequencie)), by = .(Country, Year, Sex)]
setcolorder(allAge, c("Country", "Sex", "Age", "Year", "Frequencie"))
cancer.liver <- rbind(cancer.liver,allAge)

# Selecting the important countries

cancer.liver <- cancer.liver[Country %in% c("Austria", "Cyprus", "Germany", "Malta", "Portugal", "European Union")
                             ][order(Year, Country)]

```


# Population Data

## Importing data

```{r dtPop, results= FALSE}

library(data.table)
popdt <- fread("PopulationEU.csv",
               header = TRUE, check.names=TRUE)
popdt
```

## Removing ageStart and ageLabel columns

```{r ageRemove, results= FALSE}
popdt[, c("ageStart","ageLabel","X2000","X2001","X2002","X2003","X2004","X2005","X2006","X2007","X2008","X2009","X2010"):=NULL]
popdt
```

## Renaming ageGroup column to Age

```{r ageGroup, results= FALSE}
setnames(popdt, c("ageGroup"),
                c("Age"))
popdt
```

## Morphing to long format

```{r year, results= FALSE}

popT <- melt(popdt,
            id.vars = c("Country", "Sex", "Age"),
            measure = patterns("^X"),
            variable.name = "YearX",
            value.name = c("Population"),
            na.rm = TRUE)
popT
```

## Year as numeric, removing YearX

```{r yearNum, results= FALSE}

popT[, `:=` (Year=as.numeric(gsub("[^[:digit:].]",
                            "", YearX)))]
setcolorder(popT, c("Country", "Sex", "Age", "Year", "Population"))
popT[, YearX := NULL]
popT
```

## Removing rows for total population data 

```{r totRemove, results= FALSE}
#Seeing as we are treating females and males differently, the rows regarding total population info will not be used and should be removed.

popT <- popT[Sex != "Total"]
popT
```

## Creating European Union as "Country"

```{r createEU, results= FALSE}
#EU's population is the sum of the populations for each country, by year and age group

popEU <- popT[, .(Population = sum(Population)), by = .(Year, Sex, Age)]
popEU[, Country := "European Union"]
setcolorder(popEU, c("Country", "Sex", "Age", "Year", "Population"))
pop <- rbind(popT, popEU)
pop <- pop[order(Year, Country)]
pop
```

## Creating age group category "All", combining all ages

```{r allAge, results= FALSE}

allAge <- pop[, .(Age = "All", Population = sum(Population)), by = .(Country, Year, Sex)]
setcolorder(allAge, c("Country", "Sex", "Age", "Year", "Population"))
allAge <- allAge[order(Year, Country)]
allAge
```

## Merging pop and allAge
```{r dtMerge, results= FALSE}

pop <- rbind(pop, allAge)
pop <- pop[order(Year, Country, Sex)]
pop
```

## Selecting only the countries in study

```{r selCtry, results= FALSE}

popF <- pop[Country %in% c("Austria", "Cyprus", "Germany", "Malta", "Portugal", "European Union")]
popF <- popF[order(Year, Country)]
popF
```





























