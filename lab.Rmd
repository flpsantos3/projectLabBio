---
title: "Laboratório de Bioestatística"
author: "Group 3"
date: "28 de Dezembro de 2019"
output:
  html_document:
    highlight: tango
    theme: united
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: no
      smooth_scroll: no
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r dtStart, results= FALSE}
library(here)
library(data.table)
library(unglue)
library(ggplot2)
library(magrittr)

data <- fread(here("CancerMortalityEU.csv"), 
              header = TRUE, check.names = TRUE)
popdt <- fread("PopulationEU.csv",
               header = TRUE, check.names=TRUE)
```

# Data Tidying 

## Cancer data

```{r cancerData, results= FALSE}
# Colunas certas nos dados
names(data)

cancro <- data[CancerSite %in% "Liver and Intrahepatic Bile Ducts"]


str(cancro)
cancro[, .N, by="CancerSite"] #Pode-se tirar esta coluna
cancro[, .N, by="Cause"] #Pode-se tirar esta coluna mas a ver se não se perde a informação
cancro[, .N, by="ageStart"] #Acho que se pode tirar também
cancro[, .N, by="ageLabel"] #Também acho que se pode tirar se bem que esta pode ser util à frente
cancro[, c("CancerSite", "Cause", "ageStart", "ageLabel"):=NULL]
setnames(cancro, "ageGroup", "Age")


# melt dos dados do cancro

cancer.new <- melt(cancro,
                   id.vars = c("Country","Age"),
                   variable.name = "all",
                   value.name = "Deaths")

cancer.new[, `:=` (Year=as.numeric(gsub("[^[:digit:].]",
                            "", all)))]

cancer.new[, Sex:=as.character(unglue_vec(all,"{x}_{y}",var="x"))]

cancer.new[, .N, by="Year"]
cancer.new[, .N, by="Sex"]
cancer.new[, all:=NULL]
setcolorder(cancer.new, c("Country","Age","Sex","Year","Deaths"))

# remoção de linhas com valores NA para cálculo correto do índice mortalidade
cancer.new <- na.omit(cancer.new)

# Criação do EU

cancer.EU <- cancer.new[, .(Country = "European Union", Deaths = sum(Deaths, na.rm = TRUE)), by = .(Year, Sex, Age)]
setcolorder(cancer.EU, c("Country","Age","Sex","Year","Deaths"))
cancer.liver <- rbind(cancer.new,cancer.EU)

# Criação do all

allAge <- cancer.liver[, .(Age = "All", Deaths = sum(Deaths, na.rm = TRUE)), by = .(Country, Year, Sex)]
setcolorder(allAge, c("Country", "Sex", "Age", "Year", "Deaths"))
cancer.liver <- rbind(cancer.liver,allAge)

# Selecting the important countries

cancer.liver <- cancer.liver[Country %in% c("Austria", "Cyprus", "Germany", "Malta", "Portugal", "European Union")
                             ][order(Year, Country, Sex)]
cancer.liver
```


## Population Data

```{r dtPop, results= FALSE}
# Importing data
library(data.table)
popdt <- fread("PopulationEU.csv",
               header = TRUE, check.names=TRUE)

# Removing ageStart and ageLabel columns
popdt[, c("ageStart","ageLabel","X2000","X2001","X2002","X2003","X2004","X2005","X2006","X2007","X2008","X2009","X2010","X2018"):=NULL]

# Renaming ageGroup column to Age
setnames(popdt, c("ageGroup"),
                c("Age"))

# Morphing to long format
popT <- melt(popdt,
            id.vars = c("Country", "Sex", "Age"),
            measure = patterns("^X"),
            variable.name = "YearX",
            value.name = c("Population"),
            na.rm = TRUE)

# Year as numeric, removing YearX
popT[, `:=` (Year=as.numeric(gsub("[^[:digit:].]",
                            "", YearX)))][, YearX := NULL]
setcolorder(popT, c("Country", "Sex", "Age", "Year", "Population"))

# Removing rows for total population data 

#Seeing as we are treating females and males differently, the rows regarding total population info will not be used and should be removed.
popT <- popT[Sex != "Total"]

# Creating European Union as "Country"
#EU's population is the sum of the populations for each country, by year and age group

popEU <- popT[, .(Population = sum(Population, na.rm = TRUE)), by = .(Year, Sex, Age)][, Country := "European Union"]
setcolorder(popEU, c("Country", "Sex", "Age", "Year", "Population"))
pop <- rbind(popT, popEU)
pop <- pop[order(Year, Country)]

# Creating age group category "All", combining all ages
allAge <- pop[, .(Age = "All", Population = sum(Population, na.rm = TRUE)), by = .(Country, Year, Sex)]
setcolorder(allAge, c("Country", "Sex", "Age", "Year", "Population"))
allAge <- allAge[order(Year, Country)]

# Merging pop and allAge
pop <- rbind(pop, allAge)
pop <- pop[order(Year, Country, Sex)]

# Selecting only the countries in study
popF <- pop[Country %in% c("Austria", "Cyprus", "Germany", "Malta", "Portugal", "European Union")]
popF <- popF[order(Year, Country)]

popF
```

## Merging of the two data sets

```{r final data set}
data.f <- cancer.liver[popF, on=c("Country","Age","Sex","Year")]
data.f[, mrate := round(100000*Deaths/Population,2)]
data.f[Age %in% "All"][Sex %in% "Females"][, sum(Deaths, na.rm = TRUE), by=Country]
data.f
```

## Data for the second exercice

```{r data.ex2}
data.2017 <- data.f[Year %in% "2017"][Deaths != "NA"]
data.2017$Age <- as.factor(data.2017$Age)
levels(data.2017$Age)
data.2017$Age <- factor(data.2017$Age, levels(data.2017$Age)[c(1,10,2:9,11:19)])
```


## End of the Great Tyiding


# Questions

## First Question 

### What are the time trends in the mortality rates between countries for all age groups (“All”) combined ?
#### - How do they compare with the European Union overall?

```{r Time trends for females}
data.f[Age %in% "All"][Sex %in% "Females"] %>% 
ggplot(aes(Year,mrate, group=Country, colour = Country)) +
    geom_point(size=2) +
    geom_line() +
    ggtitle("Time trends of Liver Cancer on the Female population") +
    ylab("Mortality Rate") +
    scale_x_continuous(labels=data.f[,Year], breaks = data.f[,Year])
```
  
  * Looking at the data for hepatic cancer mortality rate for females we can note an overall increasing trend for every country, as well as for the European Union.
  * Malta, Austria and Cyprus display the most irregular trends, probably explained by the lack of values for some of the ages, in these countries.
    + Austria - with increases and decreases over the years, the mortality rate has been relatively stable, comparing 2011 data to 2017.
    + Malta - an increase from 2011 (below 3) to 2017 (3,5), with a max in the year 2014. However, it remains one of the countries with the lowest mortality rate.
    + Cyprus - overall increase, with mortality peaks in 2013 and 2016.
  * For Portugal and Malta there is no data for the year 2017, which might help explain the steep decrease in mortality rate for the European Union, as there might be more countries without data for that year.
  * Portugal, Germany and EU show an overall increase, with Portugal's mortality rate increasing the most among them (5.2 to 6).
  * These five countries show lower mortality rates than the European Union for every year, except for Austria in 2012 (not taking 2017 into account).

```{r Time trends for males}
data.f[Age %in% "All"][Sex %in% "Males"] %>% 
ggplot(aes(Year,mrate, group=Country, colour = Country))+
    geom_point(size=2)+
    geom_line()+
    ggtitle("Time trends of Liver Cancer on the Male population")+
    ylab("Mortality Rate") +
    scale_x_continuous(labels=data.f[,Year], breaks = data.f[,Year])
```

  * For males, like females, there is an increase in hepatic liver mortality rate over the years.
    + An exception is Germany, showing stable values for the years 2011 and 2017.
  * Malta displays the steepest increase in 2016 (from 7 to 13.8).
  *  Portugal displays the highest values (close to 17.5) while Cyprus has the lowest (even though the increase in mortality rate over the years is on par with Portugal).
  * The overall values for mortality are higher than those of females.
  * Portugal and Austria display higher values than the European Union, while the remaining countries stay below the average (aside from 2017).


## Second question

### Compare the mortality rates by age groups between countries for 2017.

```{r ageMR_Females}
data.2017[Sex %in% "Females"][Age != "All"] %>%
ggplot(aes(Age,mrate, group=Country, colour=Country))+
    geom_point()+
    geom_line()+
    theme(axis.text.x = element_text(angle=45, vjust = 0.5))+
    ggtitle("Mortlity rate per Age group in 2017 on the Female population")+
    ylab("Mortality Rate")
```

  * In every country we see an increase on the mortality rate as the age classe increases (Starting in the 35 to 39 age classe)
  * Contrary to the other three countrys (which always increase), Cyprus mortality rate just oscilates a bit between the classes 60-64 and 75-79. After that, it catches the rest of the countries with a very high mortality rate
  * The firsts Age classes (until the classe 35-39) shown zero to very few mortality rate due to this type of cancer on the Female population
  * The trend observed here is that older population (From the age of 50 foward) is more susceptible to die due to this kind of cancer and, in this danger group, the three countries analysed here have a higher mortality rate than the European Union (except for the age classes of 50-54 and 75-79 of the female population of Cyprus)
    + Countrary to the other contries, Cyprus starts to have a higher mortality rate at the age class of 45-49


```{r ageMR_Males}
data.2017[Sex %in% "Males"][Age != "All"] %>%
ggplot(aes(Age,mrate, group=Country, colour=Country))+
    geom_point()+
    geom_line()+
    theme(axis.text.x = element_text(angle=45, vjust = 0.5))+
    ggtitle("Mortlity rate per Age group in 2017 on the Male population")+
    ylab("Mortality Rate") +
    scale_x_discrete(labels=data.f[,Age], breaks = data.f[,Age])
```

  * Again, just like in the data from the female population, we see an increase on the mortality rate as the age class increases (starting in the 30 to 34 age class)
  * The first Age classes (until the class 35-39) shown zero to very few mortality rate due to this type of cancer on the Male population
  * The trend observed here is that older population (from the age of 50 foward) is more susceptible to die due to this kind of cancer and, in this danger group, the three countries analised here have a higher mortality rate than the European Union (except Cyprus that only surpasses the European Union from the age class 65-69 forward)
  * Comparing the female and male populations, it is possible to see that the male population (peak at 94.17 in Austria) has a much higher mortality rate for this kind of cancer than the female population (peak at the 39.59 in Cyprus)

## Third Question

### Which country changed (increase or decreased) the most in percentage terms between 2011 and 2017?
#### - Plot and tabulate the percentage change overtime by country.


## Fourth Question - Most common cancers

### What are the five (5) most common cancers in 2011? in 2017 for your countries?

As we only have access to mortality data there is no way to know if the most common cancer types are the same as the most deadly. There could be cases where an individual gets cancer and recovers, and those are not reported in the data that we have access to. To answer this question we will work with the data we have and assume that the deadliest cancers are representative of the most common cancer types.

```{r allCancerSites, results=FALSE}

# Reading all cancer data
allCancer <- fread("CancerMortalityEU.csv",
               header = TRUE, check.names=TRUE)

# Removing superfluous columns
allCancer[, c("Cause", "ageStart", "ageLabel"):=NULL]
setnames(allCancer, "ageGroup", "Age")

# Converting table to long format
allCancer <- melt(allCancer,
                  id.vars = c("Country","Age","CancerSite"),
                  variable.name = "Sex+Year",
                  value.name = "Deaths")

# Separating Year and Sex data
allCancer[, `:=` (Year=as.numeric(gsub("[^[:digit:].]",
                            "", `Sex+Year`)))]
allCancer[, Sex:=as.character(unglue_vec(`Sex+Year`,"{x}_{y}",var="x"))]
allCancer[, "Sex+Year":=NULL]
setcolorder(allCancer, c("Country","Year","Sex","Age","CancerSite","Deaths"))

# Creating EU as a country
cancerEU <- allCancer[, .(Country = "European Union", Deaths = sum(Deaths)), by = .(Year, Sex, Age, CancerSite)]
setcolorder(cancerEU, c("Country","Year","Sex","Age","CancerSite","Deaths"))
allCancer <- rbind(allCancer, cancerEU)

# Creating All ages rows
allAge <- allCancer[, .(Age = "All", Deaths = sum(Deaths, na.rm = TRUE)), by = .(Country, Year, Sex, CancerSite)]
setcolorder(allAge, c("Country","Year","Sex","Age","CancerSite","Deaths"))
allCancer <- rbind(allCancer, allAge)

# Selecting the important countries
allCancer <- allCancer[Country %in% c("Austria", "Cyprus", "Germany", "Malta", "Portugal", "European Union")
                             ][order(Year, Country)]

# Removing "All Cancer" from CancerSite
allCancer <- allCancer[CancerSite != "All Cancers"]

allCancer
```

```{r cancersF11}
#Selecting cancer data for 2011
cancersF <- allCancer[Sex=="Females"][Year=="2011"][Age=="All"][order(CancerSite)]
cancersF <- cancersF[, .(Deaths = sum(Deaths, na.rm = TRUE)), by = .(CancerSite)]
cancersF[order(-Deaths), head(.SD,5)]
```
```{r cancersF17}
#Selecting cancer data for 2017
cancersF <- allCancer[Sex=="Females"][Year=="2017"][Age=="All"][order(CancerSite)]
cancersF <- cancersF[, .(Deaths = sum(Deaths, na.rm = TRUE)), by = .(CancerSite)]
cancersF[order(-Deaths), head(.SD,5)]
```
For the countries chosen (Austria, Cyprus, Germany, Malta, Portugal and the European Union), the 5 most common cancer types were the same in 2011 and 2017: Breast, Trachea/Bronchus/Lung, Colon, Pancreas and Ovary. There is a notable decrease in the ammount of deaths from 2011 to 2017 that can maybe be explained by the lack of data for 2 of the countries considered (Portugal and Malta).


```{r cancersM11}
#Selecting cancer data for 2011
cancersM <- allCancer[Sex=="Males"][Year=="2011"][Age=="All"][order(CancerSite)]
cancersM <- cancersM[, .(Deaths = sum(Deaths, na.rm = TRUE)), by = .(CancerSite)]
cancersM[order(-Deaths), head(.SD,5)]
```

```{r cancersM17}
#Selecting cancer data for 2017
library(kableExtra)
cancersM <- allCancer[Sex=="Males"][Year=="2017"][Age=="All"][order(CancerSite)]
cancersM <- cancersM[, .(Deaths = sum(Deaths, na.rm = TRUE)), by = .(CancerSite)]
cancersM[order(-Deaths), head(.SD,5)] %>%
  kable(align = "rc")%>% 
  kable_styling(bootstrap_options = "striped")
```

For males, the most common cancers changed between the years of 2011 and 2017. The most common cancer types in 2011 were Trachea/Bronchus/Lungs, Colon, Prostate, Pancreas and Stomach. In 2017, the most common cancer type remains the same but the number of deaths by Prostate and Liver cancer increase, changing the most common cancer types to Trachea/Bronchus/Lungs, Prostate, Colon, Pancreas and Liver and Intrahepatic Bile Ducts. As with females, the decrease in number of deaths can be explained by the lack of data for 2017 in Portugal and Malta.


```{r sessionInfo, echo=TRUE}
sessionInfo()
```

